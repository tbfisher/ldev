#!/usr/bin/env bash

# Sets up bash environment.

# Gets the directory containing this file.
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# shellcheck source=inc/util.sh
source "$script_dir/inc/util.sh"
# shellcheck source=inc/docker.sh
source "$script_dir/inc/docker.sh"

# current directory
pwd_dir=$(pwd)
# git/project root directory
proj_dir=$(util::realpath "$script_dir/..")

# Include docker-compose env, creating if necessary.
if [[ ! -f $proj_dir/.env ]]; then
    cp "$proj_dir/env_example" "$proj_dir/.env"
fi
# shellcheck disable=SC1090
source "$proj_dir/.env"

php_container=php
php_ide_config="serverName=$PRIMARY_DOMAIN.$BASE_DOMAIN"
drush_container=/var/www/.platform/local/deps/php/vendor/bin/drush
drush_local=$proj_dir/code/example7/.platform/local/deps/php/vendor/bin/drush
drush_uri="https://$PRIMARY_DOMAIN.$BASE_DOMAIN"
mysql_container=db
mysql_user=root
mysql_pass=$DATABASE_PASSWORD
mysql_db=$DATABASE_NAME
build_script="$script_dir/build"
pull_script="$script_dir/pull"
xdebug_script="$script_dir/xdebug"

# drush as webserver user
drush() {
    (
    cd "$proj_dir" &&
    docker exec -it \
        --env COLUMNS=$COLUMNS --env LINES=$LINES \
        --user www-data:www-data \
        "$(docker-compose ps -q $php_container)" \
        $drush_container --uri="$drush_uri" "$@"
    )
}
# drush as webserver user, with remote debugging
drush-debug() {
    (
    cd "$proj_dir" &&
    docker exec -it \
        --env COLUMNS=$COLUMNS --env LINES=$LINES \
        --env "XDEBUG_CONFIG=remote_enable=1" \
        --env "PHP_IDE_CONFIG=$php_ide_config" \
        --user www-data:www-data \
        "$(docker-compose ps -q $php_container)" \
        $drush_container --uri="$drush_uri" "$@"
    )
}
# drush as webserver user, with profiling
drush-profile() {
    (
    cd "$proj_dir" &&
    docker exec -it \
        --env COLUMNS=$COLUMNS --env LINES=$LINES \
        --env "XDEBUG_CONFIG=profiler_enable=1" \
        --user www-data:www-data \
        "$(docker-compose ps -q $php_container)" \
        $drush_container --uri="$drush_uri" "$@"
    )
}
# drush as root user (in case you want drush to write code)
drush-root() {
    (
    cd "$proj_dir" &&
    docker exec -it \
        --env COLUMNS=$COLUMNS --env LINES=$LINES \
        --user root:www-data \
        "$(docker-compose ps -q $php_container)" \
        $drush_container --uri="$drush_uri" "$@"
    )
}

# since we've aliased `drush`, provide a way to run drush on host
drush-local() {
    $drush_local "$@"
}

# interactive mysql in db container
mysql() {
    (
    cd "$proj_dir" &&
    docker exec -it \
        --env COLUMNS=$COLUMNS --env LINES=$LINES \
        "$(docker-compose ps -q $mysql_container)" \
        mysql --user=$mysql_user --password="$mysql_pass" "$mysql_db" "$@"
    )
}
# non-interative, for piping e.g. `cat some.sql | mysql-pipe`
mysql-pipe() {
    (
    cd "$proj_dir" &&
    docker exec -i \
        "$(docker-compose ps -q $mysql_container)" \
        mysql --user=$mysql_user --password="$mysql_pass" "$mysql_db"
    )
}
# non-interative mysql-dump
mysqldump() {
    (
    cd "$proj_dir" &&
    docker exec -i \
        "$(docker-compose ps -q $mysql_container)" \
        mysqldump --user=$mysql_user --password="$mysql_pass" "$mysql_db"
    )
}

# build script
build() {
    $build_script "$@"
}

# pull script
pull() {
    $pull_script "$@"
}

# enable/disable xdebug in a php-fpm container
xdebug() {
    $xdebug_script "$@"
}
